(function(){"use strict";self.importScripts("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js");const m="gemini-adventure-saves",{JSZip:b}=self;async function f(r,o){try{return await(await(await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle(m)).getDirectoryHandle(r)).getDirectoryHandle("images")).getFileHandle(`${o}.webp`)).getFile()}catch(a){return a.name!=="NotFoundError"&&console.warn(`Worker: Could not get image for node ${o}:`,a),null}}function i(r){return r?r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function x(r,o,a){let s=o.split(`
`)[0];const e=s.length>50?i(s.substring(0,50))+"...":i(s);let n=`
    <p class="generator-link">Generated by <a href="https://bxx81.github.io/gemini-adventure/" target="_blank" rel="noopener noreferrer">Gemini Adventure</a></p>
    <div class="story-container"><h1>${e}</h1><p class="theme">${i(o).replace(/\n/g,"<br>")}</p>`;for(const t of r){const l=i(t.sceneData.scene).replace(/\n/g,"<br>"),d=i(t.sceneData.imagePrompt),g=t.choiceText?`<p class="choice-text"><strong>${i(a.historyChoicePrefix)}:</strong> "${i(t.choiceText)}"</p>`:"";n+=`
            <div class="node">
                <img src="./images/${t.id}.webp" alt="${d}" class="scene-image" onerror="this.style.display='none'">
                <p class="scene-text">${l}</p>
                ${g}
            </div>
        `}return n+="</div>",`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${e}</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; line-height: 1.6; background-color: #111827; color: #d1d5db; margin: 0; padding: 20px; }
        .generator-link { text-align: center; color: #6b7280; font-size: 0.9em; margin-bottom: 20px; }
        .generator-link a { color: #818cf8; text-decoration: none; }
        .generator-link a:hover { text-decoration: underline; }
        .story-container { max-width: 800px; margin: 0 auto; background-color: #1f2937; padding: 20px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { font-size: 2.5em; text-align: center; color: #f9fafb; border-bottom: 1px solid #4b5563; padding-bottom: 10px; margin-top: 0; }
        .theme { text-align: center; font-style: italic; color: #9ca3af; margin-top: -10px; margin-bottom: 40px; }
        .node { margin-bottom: 40px; border-bottom: 1px solid #374151; padding-bottom: 40px; }
        .node:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 10px; }
        .scene-image { width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; aspect-ratio: 4 / 3; object-fit: cover; background-color: #374151; }
        .scene-text { font-size: 1.1em; }
        .choice-text { margin-top: 20px; padding: 15px; background-color: #374151; border-left: 4px solid #8b5cf6; border-radius: 4px; }
        strong { color: #c4b5fd; }
    </style>
</head>
<body>
    ${n}
</body>
</html>`}self.onmessage=async r=>{const{gameLog:o,endNodeId:a,t:s}=r.data;try{const e=new b,n=[];let t=a;for(;t;){const c=o.nodes[t];if(!c)break;n.unshift(c),t=c.parentId}const l=x(n,o.theme,s);e.file("index.html",l);const d=e.folder("images");for(const c of n){const p=await f(o.id,c.id);p&&d.file(`${c.id}.webp`,p)}const g=await e.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}});self.postMessage({success:!0,blob:g})}catch(e){console.error("Worker error during ZIP generation:",e),self.postMessage({success:!1,error:e.message})}}})();
